<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">

	<!-- Force latest available IE rendering engine and Chrome Frame (if installed) -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Timezones</title>
	<meta name="description" content="A simple timezone converter">

	<!-- Mobile Screen Resizing -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Icons: place in the root directory -->
	<!-- https://github.com/audreyr/favicon-cheat-sheet -->
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="icon" sizes="16x16 32x32" href="favicon.ico">

	<link rel="stylesheet" type="text/css" href="assets/main.css">
</head>
<body>

	<main id="main" class="container">

		<h1 class="no-margin-bottom">Timezones</h1>
		<p>Easily calculate timezones for your next meeting.</p>

		<div id="app"></div>

	</main>


	<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
	<script>

		//
		// Variables
		//

		// new Date().toLocaleTimeString('en-US', {timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit'})
		// Intl.DateTimeFormat().resolvedOptions().timeZone
		// new Date().getTimezoneOffset()
		var data = [
			{
				name: 'Hawaiian',
				cities: ['Honolulu'],
				locale: 'Pacific/Honolulu',
				offset: -10,
				active: false
			},
			{
				name: 'Alaska',
				cities: ['Fairbanks', 'Anchorage'],
				locale: 'America/Anchorage',
				offset: -9,
				active: false
			},
			{
				name: 'US Pacific',
				cities: ['Seattle', 'San Francisco', 'Palo Alto'],
				locale: 'America/Los_Angeles',
				offset: -8,
				active: true
			},
			{
				name: 'US Mountain',
				cities: ['Salt Lake City', 'Denver'],
				locale: 'America/Denver',
				offset: -7,
				active: true
			},
			{
				name: 'US Central',
				cities: ['Chicago', 'Houston', 'Dallas', 'Austin'],
				locale: 'America/Chicago',
				offset: -6,
				active: true
			},
			{
				name: 'US Eastern',
				cities: ['Boston', 'New York', 'Miami'],
				locale: 'America/New_York',
				offset: -5,
				active: true
			},
			{
				name: 'United Kingdom',
				cities: ['Dublin', 'London', 'Cardif'],
				locale: 'Europe/London',
				offset: 0,
				active: true
			},
			{
				name: 'Central European',
				cities: ['Oslo', 'Stockholm', 'Paris', 'Amersterdam', 'Madrid', 'Barcelona', 'Rome'],
				locale: 'Europe/Rome',
				offset: 1,
				active: true
			},
			{
				name: 'Eastern European',
				cities: ['Helsinki', 'Sofia', 'Athens', 'Cairo'],
				locale: 'Europe/Athens',
				offset: 2,
				active: true
			},
			{
				name: 'Central African',
				cities: ['Johannesburg', 'Cape Town'],
				locale: 'Africa/Johannesburg',
				offset: 2,
				active: true
			},
			{
				name: 'Moscow',
				cities: ['Moscow', 'Minsk'],
				locale: 'Europe/Moscow',
				offset: 3,
				active: false
			},
			{
				name: 'Indian',
				cities: ['Mumbai', 'Bangalore', 'Pune'],
				locale: 'Asia/Kolkata',
				offset: 5.5,
				active: true
			},
			{
				name: 'IndoChina',
				cities: ['Singapore'],
				locale: 'Asia/Singapore',
				offset: 7,
				active: true
			},
			{
				name: 'China',
				cities: ['Beijing', 'Shanghai'],
				locale: 'Asia/Shanghai',
				offset: 8,
				active: true
			},
			{
				name: 'Hong Kong',
				cities: ['Hong Kong'],
				locale: 'Asia/Hong_Kong',
				offset: 8,
				active: false
			},
			{
				name: 'Japan',
				cities: ['Tokyo'],
				locale: 'Asia/Tokyo',
				offset: 9,
				active: true
			},
			{
				name: 'Eastern Australia',
				cities: ['Sydney', 'Melbourne'],
				locale: 'Australia/Sydney',
				offset: 10,
				active: true
			},
			{
				name: 'Eastern Autralia - Queensland',
				cities: ['Cairns', 'Brisbane'],
				locale: 'Australia/Brisbane',
				offset: 10,
				active: true
			},
			{
				name: 'Western Australia',
				cities: ['Perth'],
				locale: 'Australia/Perth',
				offset: 8,
				active: true
			},
			{
				name: 'New Zealand',
				cities: ['Auckland', 'Wellington'],
				locale: 'Pacific/Auckland',
				offset: 12,
				active: true
			}
		];

		var convertMinutes = function (shift) {
			var minutes = shift % 60;
			var hours = (shift - minutes) / 60;
			return {
				hours: hours,
				minutes: minutes
			};
		};

		/**
		 * Get the standard UTC offset time for a location
		 * @param  {Object}  date The Date() object
		 * @return {Integer} The standard UTC offset
		 */
		var getStandardTimezoneOffset = function (date) {
			var year = date.getFullYear();
			var jan = new Date(year, 0, 1);
			var jul = new Date(year, 6, 1);
			return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
		};

		/**
		 * Get the timezone UTC offset in hours
		 * @param  {Object} date The Date() object
		 * @return {Number}      The UTC offset in hours
		 */
		var getOffset = function (date) {
			return getStandardTimezoneOffset(date) / -60;
		};

		/**
		 * Check if DST is currently observed
		 * @param  {Object} date The Date() object
		 * @return {Boolean}     If true, it's currently DST in this locale
		 */
		var isDSTObserved = function (date) {
			return date.getTimezoneOffset() < getStandardTimezoneOffset(date);
		};

		var getCurrentTime = function (date) {
			var minutes = date.getMinutes() > 30 ? 0 : 30;
			date.setMinutes(minutes);
			if (minutes === 0) {
				date.setHours(date.getHours() + 1);
			}
			return date;
		};

		var getLocalTime = function (date) {
			var offset = getOffset(date);
			return data.find(function(timezone) {
				return timezone.offset === offset;
			});
		};

		var getLocation = function (date) {
			var offset = getOffset(date);
			return document.querySelector('.timezone[data-offset="' + offset + '"]');
		};

		var setLocation = function (local) {
			if (!local) return;
			local.classList.add('local');
		};

		var getTimeShift = function (date, locale) {
			var time = new Date(date.toLocaleString('en-US', {timeZone: locale})).getTime();
			var shift = (date.getTime() - time) / 60 / 1000;
			return Math.floor(shift);
		};

		var getTime = function (date, locale) {
			return date.toLocaleTimeString('en-US', {timeZone: locale, hour12: false, hour: '2-digit', minute: '2-digit'});
		};

		var getDate = function (date, locale) {
			return new Date(date.toLocaleString('en-US', {timeZone: locale})).getDate();
		};

		var getDateMessage = function (day, localDay, isLocal) {
			if (isLocal) {
				return '<strong>This is you.</strong>';
			}

			if (localDay < day) {
				return '<span class="text-warning">Day <strong>before</strong> today their time.</span>';
			}

			if (localDay > day) {
				return '<span class="text-warning">Day <strong>after</strong> today their time.</span>';
			}

			return '<span class="text-info">Same day as you.</span>';
		};

		var setDateMessage = function (date, locale, timezone) {
			var msg = timezone.closest('.timezone').querySelector('[data-type="date"]');
			if (!msg) return;
			msg.innerHTML = getDateMessage(date.getDate(), getDate(date, locale), timezone.matches('.local'));
		};

		var setTimes = function (date, timezones) {
			timezones.forEach(function (timezone) {
				var select = timezone.querySelector('[data-type="time"]');
				var locale = select.getAttribute('data-locale');
				var dateMessage;
				select.value = getTime(date, locale);
				setDateMessage(date, locale, timezone);
			});
		};

		var padStart = function (num) {
			num = num.toString();
			return num.length < 2 ? '0' + num : num;
		};

		var renderTimeOptions = function (current) {
			var ante = ['am', 'pm'];
			var hours = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
			var minutes = ['00', '30'];
			var times = '';
			ante.forEach(function (a) {
				hours.forEach(function (hour) {
					minutes.forEach(function (min) {
						var time = padStart(a === 'pm' && hour !== 12 ? hour + 12 : (a === 'am' && hour === 12 ? '00' : hour))  + ':' + min;
						times += '<option value="' + padStart(time) + '"' + (time === current ? ' selected' : '') + '>' + hour + ':' + min + ' ' + a + '</option>';
					});
				});
			});
			return times;
		};

		var renderTimezone = function (date, timezone, index) {
			var current = getTime(date, timezone.locale);
			var isLocal = timezone.offset === getOffset(date);
			var content =
				'<div class="timezone' + (isLocal ? ' local' : '') + '">' +
					'<h2 class="no-padding-top no-margin-bottom">' + timezone.name + '</h2>' +
					'<div class="row">' +
						'<div class="grid-two-fifths margin-bottom-small">' +
							'<span class="text-muted text-small" data-type="cities">' + timezone.cities.join(', ') + '</span>' +
						'</div>' +
						'<div class="grid-fifth" data-type="times">' +
							'<label class="screen-reader" for="time-' + index + '">Time</label>' +
							'<select class="margin-bottom-small" data-type="time" data-locale="' + timezone.locale + '" data-time-shift="' + getTimeShift(date, timezone.locale) + '" id="time-' + index + '">' +
								renderTimeOptions(current) +
							'</select>' +
						'</div>' +
						'<div class="grid-two-fifths margin-bottom-small" data-type="date">' +
							getDateMessage(date.getDate(), getDate(date, timezone.locale), isLocal) +
						'</div>' +
					'</div>' +
				'</div>';

			return content;
		};

		var renderApp = function (date) {
			var app = document.querySelector('#app');
			var content = '';
			data.forEach(function (timezone, index) {
				if (!timezone.active) return;
				content += renderTimezone(date, timezone, index);
			});
			app.innerHTML = content;
		};

		var handleTimechange = function (event) {

			if (!event.target.matches('[data-type="time"]')) return;

			var time = new Date();
			var selected = event.target.value.split(':');
			var shift = convertMinutes(event.target.getAttribute('data-time-shift'));
			var timezones = Array.from(document.querySelectorAll('.timezone'));

			time.setHours(parseInt(selected[0], 10) + shift.hours, parseInt(selected[1], 10) + shift.minutes, '00');

			setTimes(time, timezones);

		};


		//
		// Inits & Event Listeners
		//

		var date = getCurrentTime(new Date());

		// Render the app
		renderApp(date);

		// Get the current location offset
		var local = getLocation(date);
		setLocation(local);

		// Detect time changes
		document.addEventListener('change', handleTimechange, false);

		// Update the time every 15 minutes
		window.setTimeout(function () {
			date = getCurrentTime(new Date());
		}, 1000 * 60 * 15);

	</script>
</body>
</html>